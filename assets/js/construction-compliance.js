// construction-compliance.js

const { jsPDF } = window.jspdf;

document.getElementById("client-btn").addEventListener("click", () => showForm("Client"));
document.getElementById("contractor-btn").addEventListener("click", () => showForm("Contractor"));
document.getElementById("hns-pro-btn").addEventListener("click", () => showForm("Health & Safety Professional"));

function showForm(role) {
  const formContainer = document.getElementById("project-form-container");
  formContainer.classList.remove("hidden");
  const form = document.getElementById("project-form");
  if (role === "Client") {
    form.insertAdjacentHTML("beforeend", `<label for="baseline-risk">Baseline Risk Assessment Details:</label><textarea id="baseline-risk" name="baselineRisk" aria-label="Baseline Risk"></textarea>`);
  } else if (role === "Health & Safety Professional") {
    form.insertAdjacentHTML("beforeend", `<label for="sacpcmp-reg">SACPCMP Registration:</label><input type="text" id="sacpcmp-reg" name="sacpcmpReg" aria-label="SACPCMP Registration">`);
  }
  console.log(`${role} form displayed`);
}

document.getElementById("project-form").addEventListener("submit", function (e) {
  e.preventDefault();

  // Validation
  const emergencyContact = document.getElementById("emergency-contact").value;
  const scopeDetails = document.getElementById("scope-details").value;
  if (!/^\+?\d{10,}$/.test(emergencyContact)) {
    alert("Please enter a valid phone number for emergency contact.");
    return;
  }
  if (scopeDetails.length < 50) {
    alert("Scope details must be at least 50 characters.");
    return;
  }

  // Form data
  const formData = {
    clientName: document.getElementById("client-name").value,
    contractorName: document.getElementById("contractor-name").value,
    siteAddress: document.getElementById("site-address").value,
    contractsManager: document.getElementById("contracts-manager").value,
    managingDirector: document.getElementById("managing-director").value,
    typeOfWork: document.getElementById("type-of-work").value,
    workArea: document.getElementById("work-area").value,
    emergencyContact,
    workmansComp: document.getElementById("workmans-comp").value,
    projectName: document.getElementById("project-name").value,
    location: document.getElementById("location").value,
    scopeDetails,
    cost: document.getElementById("cost").value,
    duration: document.getElementById("duration").value,
    activities: Array.from(document.querySelectorAll('input[name="activities"]:checked')).map((input) => input.value),
    cidbGrade: document.getElementById("cidb-grade").value,
    dateCompiled: "April 14, 2025",
  };

  if (!window.jspdf || !window.jspdf.jsPDF) {
    alert("Error: PDF generation library not loaded.");
    return;
  }

  const doc = new jsPDF({ orientation: "portrait", unit: "mm", format: "a4" });

  function addHeaderFooter(pageNum) {
    doc.setFillColor(26, 37, 38);
    doc.rect(0, 0, 210, 15, "F");
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(12);
    doc.text("Salatiso OHS Tools", 10, 10);
    doc.text(`Page ${pageNum}`, 200, 10, { align: "right" });
    if (pageNum !== 1) {
      doc.setTextColor(200, 200, 200);
      doc.text("Generated by Salatiso OHS Tools", 105, 148.5, { angle: 45, align: "center" });
    }
    doc.setTextColor(0, 0, 0);
    doc.setFontSize(8);
    doc.text("Â© 2025 Salatiso OHS Tools | salatiso@safetyfirst.help", 105, 290, { align: "center" });
  }

  // Page 1: Cover
  doc.setFillColor(255, 255, 255);
  doc.rect(0, 0, 210, 297, "F");
  addHeaderFooter(1);
  doc.setFontSize(20);
  doc.setFont("helvetica", "bold");
  doc.text(`OHS Specifications: ${formData.projectName}`, 105, 50, { align: "center" });
  doc.autoTable({
    startY: 80,
    head: [["Field", "Details"]],
    body: [
      ["Client Name", formData.clientName],
      ["Contractor Name", formData.contractorName],
      ["Project Name", formData.projectName],
      ["Date Compiled", formData.dateCompiled],
    ],
    theme: "grid",
    styles: { fontSize: 10 },
  });
  doc.setFontSize(8);
  doc.text("Complies with Construction Regulation 5(1)(b). Verify with a professional.", 105, 280, { align: "center" });

  // Page 2: Client Details
  doc.addPage();
  addHeaderFooter(2);
  doc.setFontSize(12);
  doc.setFont("helvetica", "bold");
  doc.text("Client Details", 10, 20);
  doc.autoTable({
    startY: 30,
    head: [["Field", "Details"]],
    body: [
      ["Company Name", formData.clientName],
      ["Contact Person", formData.contractsManager],
      ["Contact Details", formData.emergencyContact],
    ],
    theme: "grid",
    styles: { fontSize: 10 },
  });

  // Page 3: Scope & Contractor Details
  doc.addPage();
  addHeaderFooter(3);
  doc.setFontSize(12);
  doc.setFont("helvetica", "bold");
  doc.text("Scope of Work & Contractor Details", 10, 20);
  doc.setFontSize(10);
  doc.setFont("helvetica", "normal");
  doc.text("Scope of Work", 10, 30);
  doc.text(formData.scopeDetails, 10, 40, { maxWidth: 190 });
  doc.autoTable({
    startY: 60,
    head: [["Field", "Details"]],
    body: [
      ["Company Name", formData.contractorName],
      ["Contact Person", formData.managingDirector],
      ["COIDA Registration Number", formData.workmansComp],
    ],
    theme: "grid",
    styles: { fontSize: 10 },
  });

  // Page 4: Contents
  doc.addPage();
  addHeaderFooter(4);
  doc.setFontSize(12);
  doc.setFont("helvetica", "bold");
  doc.text("Contents", 10, 20);
  doc.setFontSize(10);
  doc.setFont("helvetica", "normal");
  const contents = [
    "1. Purpose",
    "2. Interpretation",
    "   2.1 Scope",
    "   2.2 References",
    "   2.3 Definitions",
    "3. Administrative Requirements",
    // ... rest from specification
    "8. Responsibilities Table",
    "9. Acknowledgement",
  ];
  contents.forEach((line, i) => doc.text(line, 10, 30 + i * 4));

  // Page 5: Purpose
  doc.addPage();
  addHeaderFooter(5);
  doc.setFontSize(12);
  doc.setFont("helvetica", "bold");
  doc.text("1. Purpose", 10, 20);
  doc.setFontSize(10);
  doc.setFont("helvetica", "normal");
  doc.text(
    `This Health and Safety Specification establishes the minimum OHS requirements for contractors performing construction work on ${formData.clientName}'s premises...`,
    10,
    30,
    { maxWidth: 190 }
  );

  // Page 6+: Other Sections (abridged)
  // Add Interpretation, Administrative Requirements, etc., following specification
  if (formData.activities.includes("Scaffolding")) {
    doc.addPage();
    addHeaderFooter(6);
    doc.setFontSize(12);
    doc.setFont("helvetica", "bold");
    doc.text("6.14 Scaffolding", 10, 20);
    doc.setFontSize(10);
    doc.setFont("helvetica", "normal");
    doc.text("Comply with Construction Regulation 16 and SANS 10085, including competent supervisors...", 10, 30, { maxWidth: 190 });
  }

  // Responsibilities Table
  doc.addPage();
  addHeaderFooter(7);
  doc.setFontSize(12);
  doc.setFont("helvetica", "bold");
  doc.text("8. Responsibilities Table", 10, 20);
  doc.autoTable({
    startY: 30,
    head: [["Party", "Responsibility", "Reference"]],
    body: [
      ["Client", `Provide Baseline Risk Assessment for ${formData.projectName}`, "Construction Regulation 5(1)(a)"],
      ["Contractor", "Develop Health and Safety Plan", "Construction Regulation 7"],
      ["Designer", "Design structures to minimize risks", "Construction Regulation 6(1)(a)"],
    ],
    theme: "grid",
    styles: { fontSize: 8, cellPadding: 2 },
  });

  // Acknowledgement
  doc.addPage();
  addHeaderFooter(8);
  doc.setFontSize(12);
  doc.setFont("helvetica", "bold");
  doc.text("9. Acknowledgement", 10, 20);
  doc.setFontSize(10);
  doc.setFont("helvetica", "normal");
  doc.text("Thus done and signed by the respective parties as follows:", 10, 30);
  doc.text(`For: Contractor\nName: ${formData.contractorName}\nSignature: ________________\nDate: ${formData.dateCompiled}`, 10, 40);
  doc.text(`For: Client\nName: ${formData.clientName}\nSignature: ________________\nDate: ${formData.dateCompiled}`, 100, 40);

  // Save PDF
  doc.save(`OHS_Specifications_${formData.projectName.replace(/\s+/g, "_")}.pdf`);

  // Update cart
  const cartItems = document.getElementById("cart-items");
  const cartContainer = document.getElementById("cart-container");
  cartContainer.classList.remove("hidden");
  const row = document.createElement("tr");
  row.innerHTML = `<td>OHS Specifications - ${formData.projectName}</td><td>R250</td>`;
  cartItems.appendChild(row);
});

// Checkout
document.getElementById("checkout-btn").addEventListener("click", () => {
  const promoCode = document.getElementById("promo-code").value;
  if (promoCode === "SAFETYFREE2025") {
    alert("Promo code applied! Document downloaded.");
  } else {
    alert("Invalid promo code. Proceed to payment.");
    setTimeout(() => alert("Payment successful!"), 1000);
  }
});
